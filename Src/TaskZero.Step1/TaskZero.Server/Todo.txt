====================
TASKZERO.STEP 1
====================

1) To start off, set the version number of the demo. Open **TaskZeroSettings.cs** and change the **Version** constant to 1.

2) Add the following Nuget packages on the TaskZero.Server project
    MementoFX
    MementoFX.Persistence.MongoDB
    MementoFX.Messaging.Postie
    MementoFX.Messaging.Postie.Unity

3) Now let's set up the framework at the start of the application. Create a new file **MementoStartup.cs** in the root of the project and copy the C# code below in it.

using System;
using Memento.Messaging;
using Memento.Messaging.Postie;
using Memento.Messaging.Postie.Unity;
using Memento.Persistence;
using Microsoft.Practices.Unity;

namespace TaskZero.Server
{
    public class MementoStartup
    {
        public static UnityContainer UnityConfig(Type busType, Type eventStoreType)
        {
            var container = new UnityContainer();
            container.RegisterType<ITypeResolver, UnityTypeResolver>
    (new InjectionConstructor(container));
    container.RegisterType(typeof(IBus), busType);
    container.RegisterType(typeof(IEventDispatcher), busType);
    container.RegisterType<IRepository, Repository>
        (new InjectionConstructor(eventStoreType));
        container.RegisterType(typeof(IEventStore),
        eventStoreType,
        new InjectionConstructor(typeof(IEventDispatcher)));

        return container;
        }

        public static UnityContainer UnityConfig<TBus, TEventStore>
            ()
            {
            var container = new UnityContainer();

            container.RegisterType<ITypeResolver, UnityTypeResolver>
                (new InjectionConstructor(container));
                container.RegisterType(typeof(IBus), typeof(TBus));
                container.RegisterType(typeof(IEventDispatcher), typeof(TBus));
                container.RegisterType<IRepository, Repository>
                    (new InjectionConstructor(typeof(TEventStore)));
                    container.RegisterType(typeof(IEventStore), typeof(TEventStore),
                    new InjectionConstructor(typeof(IEventDispatcher)));

                    return container;
                    }
                    }
                    }
    
    4) Add the following properties to the **global.asax.cs** class
    
       public static IBus Bus { get; private set; }
       public static IRepository AggregateRepository { get; private set; }

    5) Add the following code at the end of Application_Start in **global.asax.cs**. This code will initialize the MementoFX framework.

    // Configure the MementoFX
    var container = MementoStartup.UnityConfig<InMemoryBus, MongoDbEventStore>();

    // Save global references to the FX core elements
    Bus = container.Resolve<IBus>();
    AggregateRepository = container.Resolve<IRepository>();
    
    // Add sagas and handlers to the bus

    6) Import all namespaces and make sure you also have 

    using Microsoft.Practices.Unity;

    7) Create a folder **Commands** in the **TaskZero.CommandStack** project.

    8) Create a C# file in the folder: **NotifyCommand.cs**. Make sure you import all references. In particular, you need to reference **Memento**.

    using Memento;

    namespace TaskZero.CommandStack.Commands
    {
    public class NotifyCommand : Command
    {
    public NotifyCommand(string connectionId = "")
    {
    SignalrConnectionId = connectionId;
    }

    public string SignalrConnectionId { get; }
    }
    }

    9) Create a C# file in the folder: **AddNewTaskCommand.cs**. In particular, you need to reference **TaskZero.Shared**.

    using System;
    using TaskZero.Shared;

    namespace TaskZero.CommandStack.Commands
    {
    public class AddNewTaskCommand : NotifyCommand
    {
    public AddNewTaskCommand(string title,
    string description,
    DateTime? dueDate,
    Priority priority,
    string connectionId) : base(connectionId)
    {
    Title = title;
    Description = description;
    DueDate = dueDate;
    Priority = priority;
    }

    public string Title { get; set; }
    public string Description { get; set; }
    public DateTime? DueDate { get; set; }
    public Priority Priority { get; set; }
    }
    }

    10) Create a folder Events in **TaskZero.Shared** and add **TaskCreatedEvent.cs**. Reference MementoFX.
	
	using System;
using Memento;

namespace TaskZero.Shared.Events
{
    public class TaskCreatedEvent : DomainEvent
    {
        public TaskCreatedEvent(Guid id, string title, string description, DateTime? dueDate, Priority priority)
        {
            TaskId = id;
            Title = title;
            Description = description;
            DueDate = dueDate;
            Priority = priority;
        }

        public Guid TaskId { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public DateTime? DueDate { get; set; }
        public Priority Priority { get; set; }
    }
}


11) Create a folder **Model** in the **TaskZero.CommandStack** project and create a **Task.cs** file in it.

using System;
using Memento.Domain;
using TaskZero.Shared;
using TaskZero.Shared.Events;

namespace TaskZero.CommandStack.Model
{
    public class Task : Aggregate, IApplyEvent<TaskCreatedEvent>
    {
        public Task()
        {
            Priority = Priority.Normal;
            Status = Status.ToDo;
            Enabled = true;
            Deleted = false;
        }

        // COMMON PROPERTIES
        public bool Deleted { get; set; }
        public bool Enabled { get; set; }

        // SPECIFIC PROPERTIES
        public Guid TaskId { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public DateTime? DueDate { get; set; }
        public Priority Priority { get; set; }
        public Status Status { get; set; }

        public void ApplyEvent(
            [AggregateId("TaskId")] TaskCreatedEvent theEvent)
        {
            TaskId = theEvent.TaskId;
            Title = theEvent.Title;
            Description = theEvent.Description;
            DueDate = theEvent.DueDate;
            Priority = theEvent.Priority;
        }

        public static class Factory
        {
            public static Task NewTaskFrom(string title, string descrition, DateTime? dueDate = null, Priority priority = Priority.Normal)
            {
                var task = new Task();
                var created = new TaskCreatedEvent(Guid.NewGuid(), title, descrition, dueDate, priority);
                task.RaiseEvent(created);
                return task;
            }
        }
    }
}

12) In **Views/Dashboard/index.cshtml** change the "add new task..." button as below:

<a role="button" class="btn btn-primary btn-lg" href="@Url.Action("new", "task")">
    add new task ...
</a>

13) Open **Application/ApplicationServiceBase.cs** and replace the content with the following:

using Memento.Messaging.Postie;

namespace TaskZero.Server.Application
{
    public class ApplicationServiceBase
    {
        public ApplicationServiceBase(IBus bus)
        {
            Bus = bus;
        }
        public IBus Bus { get; }
    }
}

Because of this change, add a new constructor to **DashboardService.cs**

public DashboardService(IBus bus) : base(bus)
{
}

Edit the initialization of the DashboardService instance in **dashboardcontroller.cs**

private readonly DashboardService _service = new DashboardService(TaskZeroApplication.Bus);

14) Add a new folder **Task** in **Models** and create in it **TaskInputModel.cs**

using System;
using TaskZero.Shared;

namespace TaskZero.Server.Models.Task
{
    public class TaskInputModel  
    {
        public TaskInputModel()
        {
            DueDate = null;
            Priority = Priority.NotSet;
            Status = Status.ToDo;
        }

        public Guid TaskId { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public DateTime? DueDate { get; set; }
        public Priority Priority { get; set; }
        public Status Status { get; set; }

        public string SignalrConnectionId { get; set; }
    }
}

In the same folder, also create **TaskViewModel.cs**

namespace TaskZero.Server.Models.Task
{
    public class TaskViewModel : ViewModelBase
    {
        
    }
}

15) Add a new service class in Application folder: **TaskService.cs**. Reference CommandStack.

using Memento.Messaging.Postie;
using TaskZero.CommandStack.Commands;
using TaskZero.Server.Models.Task;

namespace TaskZero.Server.Application
{
    public class TaskService : ApplicationServiceBase
    {
        public TaskService(IBus bus) : base(bus)
        {
        }


        #region QUERY methods
        public TaskViewModel GetDefaultTask()
        {
            var model = new TaskViewModel();
            return model;
        }
        #endregion


        #region COMMAND methods
        public void QueueAddOrSaveTask(TaskInputModel input)
        {
            var command = new AddNewTaskCommand(
                input.Title,
                input.Description,
                input.DueDate,
                input.Priority,
                input.SignalrConnectionId);
            Bus.Send(command);
        }
        #endregion
    }
}

16) Add **TaskController.cs**

using System;
using System.Web.Mvc;
using TaskZero.Server.Application;
using TaskZero.Server.Models.Task;
using TaskZero.Shared;

namespace TaskZero.Server.Controllers
{
    [Authorize]
    public class TaskController : AppController 
    {
        private readonly TaskService _service = new TaskService(TaskZeroApplication.Bus);

        #region ADD TASK
        [HttpGet]
        public ActionResult New()
        {
            var model = _service.GetDefaultTask();
            return View(model);
        }

        [HttpPost]
        public ActionResult Save(TaskInputModel input)
        {
            // If it doesn't crash a serious bus has the message
            // in store and will eventually deliver it.
            // To update the UI, you should actually wait for 
            // the operation to complete. It's only started here.
            try
            {
                _service.QueueAddOrSaveTask(input);
            }
            catch (Exception exception)
            {
                return HandleException(exception);
            }

            // Message delivered
            var response = new CommandResponse(true)
                .SetPartial()
                .AddMessage("Delivered");
            return Json(response);
        }
        #endregion
    }
}

17) Create a **Task** folder in Views and add **new.cshtml** in it.

